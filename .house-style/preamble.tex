% !TEX TS-program = xelatex
% File: preamble.tex
% Purpose: Brett Reynolds house style LaTeX preamble (Press edition)
% Version: 2.0.0
%
% Usage: \input{.house-style/preamble.tex} in main document

% =========================
% PRESS-LIKE PAGE (trim + margins)
% =========================
% 7×10 trim with practical press margins
\usepackage[
  paperwidth=7in,paperheight=10in,
  inner=1in,
  outer=1in,
  top=1in,
  bottom=1.25in,
  bindingoffset=0.25in
]{geometry}

\linespread{1.05}

\setlength{\parindent}{1.2em}
\setlength{\parskip}{0pt}
\raggedbottom  % practical for drafts; flushbottom requires manual page-break work
\setlength{\emergencystretch}{1.5em} % smoother justification; fewer ugly breaks

% Widow/orphan control
\widowpenalty=10000
\clubpenalty=10000

% Hyphenation exceptions (protect proper names and technical terms)
\hyphenation{Huddleston Pullum Langacker Goldberg Chomsky Labov Haspelmath
  Bybee Croft Givón Millikan Boyd Khalidi Saussure Jakobson Bloomfield
  homeostatic projectibility entrenchment grammaticalization}

% --- Language ---
\usepackage[british]{babel}            % British conventions; use -ize spellings in prose

% =========================
% FONTS (real bold + real small caps)
% =========================
\usepackage{fontspec}
\defaultfontfeatures{Ligatures=TeX, Scale=MatchLowercase}

% EB Garamond: available on system, has true bold + small caps, excellent for long text.
\setmainfont{EB Garamond}[Numbers=OldStyle]
\setsansfont{Palatino}
\setmonofont{Menlo}[Scale=0.85]

% Charis SIL fallback for IPA and extended Latin (linguistics-specific characters)
\newfontfamily\ipafont{Charis SIL}[Scale=MatchLowercase]
\newcommand{\ipa}[1]{{\ipafont #1}}

\newfontfamily\japanesefont{Hiragino Sans GB}  % Japanese/CJK fallback
\usepackage{xeCJK}                             % CJK support
\setCJKmainfont{Hiragino Sans GB}              % Set CJK font

% =========================
% MICROTYPE (XeLaTeX: protrusion only; tracking requires pdftex)
% =========================
\usepackage[final,protrusion=true,expansion=false]{microtype}

% --- Color and graphics ---
\usepackage{xcolor}                    % Color support
\usepackage{eso-pic}                   % Background images (for cover)
\usepackage{tikz}                      % Graphics (for cover shadow)
\usetikzlibrary{shadows.blur}          % Blur shadows
\usetikzlibrary{arrows.meta, positioning, shapes.geometric}
\usepackage{graphicx}                  % For including images
\usepackage{framed}                    % For framed boxes (skip paths)
\usepackage{float}                     % For [H] forced float placement

\usepackage[normalem]{ulem}            % \uline for underlining (normalem preserves \emph)
\usepackage{marvosym}                  % \Cross symbol for cross-linguistic subscripts

% --- Quotation marks ---
\usepackage{csquotes}                  % \enquote{…} with locale-aware quoting
\setquotestyle{english}                % Use double quotes even under british babel

% Block quotations: same size, indented (Bringhurst)
\usepackage{quoting}
\quotingsetup{leftmargin=2em, rightmargin=0pt, vskip=0.5\baselineskip}

\usepackage{orcidlink}

% =========================
% HYPERREF (keeping current link colours per user preference)
% =========================
\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  linkcolor=blue,
  citecolor=blue,
  urlcolor=blue,
  pdfauthor={Brett Reynolds},
  pdftitle={Words That Won't Hold Still: How Linguistic Categories Work}
}
\urlstyle{same}

% =========================
% RUNNING HEADS + CONSISTENT FOLIOS
% =========================
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}

% Folios outside, headers inside (classic academic look)
\fancyhead[LE]{\thepage}
\fancyhead[RO]{\thepage}
\fancyhead[RE]{\small\scshape\leftmark}
\fancyhead[LO]{\small\scshape\rightmark}

% Clean marks (no "CHAPTER 1." shouting)
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{#1}}

% Make chapter-opening pages match (book.css consistency)
\fancypagestyle{plain}{
  \fancyhf{}
  \renewcommand{\headrulewidth}{0pt}
  \fancyhead[LE]{\thepage}
  \fancyhead[RO]{\thepage}
}

% Suppress headers/folios on inserted blank pages
\usepackage{emptypage}

% =========================
% HEADINGS: clearer hierarchy + no orphaned heads
% =========================
\usepackage{titlesec}
\usepackage{needspace}
\usepackage{etoolbox}

% Chapter: restrained but unmistakable (Bringhurst: same weight, larger size)
\titleformat{\chapter}[display]
  {\normalfont\huge}
  {}
  {0pt}
  {\Huge}
  [\vspace{1.2ex}]

% Section: small caps, number in margin (Bringhurst-style)
\titleformat{\section}
  {\normalfont\large\scshape}
  {\llap{\thesection\quad}}
  {0pt}
  {}
% Subsection: small caps, number inline
\titleformat{\subsection}
  {\normalfont\normalsize\scshape}
  {\thesubsection\quad}
  {0pt}
  {}

\titlespacing*{\section}{0pt}{2.0ex plus 0.6ex}{0.9ex}
\titlespacing*{\subsection}{0pt}{1.6ex plus 0.5ex}{0.7ex}

% Keep heads with text
\pretocmd{\section}{\needspace{5\baselineskip}}{}{}
\pretocmd{\subsection}{\needspace{4\baselineskip}}{}{}

% =========================
% CAPTIONS (apparatus, not body text)
% =========================
\usepackage[font=small,labelfont=bf,labelsep=period]{caption}
\captionsetup{skip=6pt}

% --- Maths and symbols ---
\usepackage{amsmath,amssymb}
\usepackage{pgfplots}                  % For data-driven figures
\pgfplotsset{compat=1.18}
\usepackage{epigraph}                  % For chapter epigraphs
\usepackage{booktabs}
\usepackage{makecell}

% --- Numbered linguistic examples (LangSci/gb4e wrapper, no 'exe' env) ---
\usepackage{langsci-gb4e}
\makeatletter
\@ifundefined{noautomath}{}{\noautomath}
\makeatother

% --- Lists & small utilities ---
\usepackage{enumitem}
\setlist{itemsep=0.3\baselineskip, topsep=0.3\baselineskip}
\usepackage{xspace}

% =========================
% Bibliography (biblatex)
% =========================
% Default portable setup:
\usepackage[backend=biber,style=apa,natbib=true,doi=true,isbn=false,url=true]{biblatex}
\addbibresource{references.bib}

% If working in LangSci projects, you can switch to their unified style:
% \usepackage[backend=biber,style=unified,natbib=true,doi=true,isbn=false,url=false]{biblatex}

% =========================
% Light house macros
% =========================
% Linguistic mentions (italics, for words as examples)
\newcommand{\mention}[1]{\textit{#1}}

% Mentions in headings: angle brackets (since headings are small-caps/italic)
% Protected so it writes unexpanded to .toc/.aux files
\DeclareRobustCommand{\mentionhead}[1]{$\langle$\textup{#1}$\rangle$}

% TOC-specific version: bare italic (angle brackets look odd in roman TOC)
\newcommand{\tocmention}[1]{\textit{#1}}

% Redefine \mentionhead to \tocmention while typesetting TOC
\AddToHook{cmd/tableofcontents/before}{%
  \let\savedmentionhead\mentionhead
  \let\mentionhead\tocmention
}
\AddToHook{cmd/tableofcontents/after}{%
  \let\mentionhead\savedmentionhead
}

% Technical terms when introduced (small caps, for key theoretical concepts)
\newcommand{\term}[1]{\textsc{#1}}

% Use \emph{} for emphasis (sparingly; semantically meaningful emphasis)

% Small-caps abbreviations for glosses (letterspaced per Bringhurst)
% Using fontspec's LetterSpace since microtype tracking doesn't work with XeLaTeX
\newcommand{\abbr}[1]{{\addfontfeatures{LetterSpace=5}\textsc{#1}}}

% Cross-linguistic subscript marker (e.g., \textsc{subject}\crossmark)
\newcommand{\crossmark}{\textsubscript{\Cross}}

% Judgement markers
\newcommand{\ungram}[1]{*\!#1}
\newcommand{\marg}[1]{\textsuperscript{?}\!#1}
\newcommand{\mmark}[1]{\textsuperscript{?}\!#1}  % alias for \marg
\newcommand{\mmmark}[1]{\textsuperscript{??}\!#1}  % double question mark
\newcommand{\odd}[1]{\#\!#1}

% e.g., i.e., etc., with sensible spacing
\newcommand{\eg}{e.g.,\xspace}
\newcommand{\ie}{i.e.,\xspace}
\newcommand{\etc}{etc.\xspace}

% =========================
% Indices (imakeidx)
% =========================
\usepackage{imakeidx}

% Three indices: Subject (concepts), Names (authors), Lexical (mentioned words)
\makeindex[name=subject, title=Subject Index, columns=2, intoc]
\makeindex[name=names, title=Name Index, columns=2, intoc]
\makeindex[name=lexical, title=Lexical Index, columns=2, intoc]

% Helper macros for consistent indexing
\newcommand{\ixs}[1]{#1\index[subject]{#1}}         % Subject: inline + tag
\newcommand{\ixn}[1]{#1\index[names]{#1}}           % Names: inline + tag
\newcommand{\ixl}[1]{\textit{#1}\index[lexical]{#1@\textit{#1}}} % Lexical: italicised + sorted correctly
\newcommand{\ixsq}[1]{\index[subject]{#1}}          % Subject: tag only (quiet)
\newcommand{\ixnq}[1]{\index[names]{#1}}            % Names: tag only (quiet)
\newcommand{\ixlq}[1]{\index[lexical]{#1@\textit{#1}}} % Lexical: tag only (quiet), sorted correctly

% Label index pages with a page-number ref target
\makeatletter
\newcommand{\indexpagelabel}[1]{\phantomsection\def\@currentlabel{\thepage}\label{#1}}
\makeatother

% =========================
% Glossary (glossaries-extra)
% =========================
\usepackage[toc, acronym, nopostdot, nonumberlist]{glossaries-extra}
\setabbreviationstyle[acronym]{long-short}

% Glossary entries are defined in glossary.tex (input from main document)
\makeglossaries
\glsdisablehyper
\setglossarystyle{altlist}

% Small caps for glossary headwords - must switch to medium weight first (EBGaramond lacks bold small caps)
\AtBeginDocument{%
  \renewcommand*{\glossentryname}[1]{{\mdseries\textsc{\glsentryname{#1}}}}%
}


