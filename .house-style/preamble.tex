% !TEX TS-program = xelatex
% File: preamble.tex
% Purpose: Brett Reynolds house style LaTeX preamble
% Version: 1.0.0
%
% Usage: \input{.house-style/preamble.tex} in main document

% --- Layout & language ---
\usepackage[margin=1in]{geometry}
\usepackage[british]{babel}            % British conventions; use -ize spellings in prose
\usepackage{fontspec}                  % Xe/LuaLaTeX
\IfFontExistsTF{Charis SIL}{
  \setmainfont{Charis SIL}
}{
  % Fallback: direct path to local font files (keeps house font)
  \setmainfont{Charis SIL}[
    Path=/Users/brettreynolds/Library/Fonts/,
    UprightFont=CharisSIL-Regular.ttf,
    BoldFont=CharisSIL-Bold.ttf,
    ItalicFont=CharisSIL-Italic.ttf,
    BoldItalicFont=CharisSIL-BoldItalic.ttf
  ]
}
\newfontfamily\japanesefont{Hiragino Sans GB}  % Japanese/CJK fallback
\usepackage{xeCJK}                             % CJK support
\setCJKmainfont{Hiragino Sans GB}              % Set CJK font
\usepackage[final]{microtype}
\usepackage[normalem]{ulem}            % \uline for underlining (normalem preserves \emph)
\usepackage[normalem]{ulem}            % \uline for underlining (normalem preserves \emph)
\usepackage{marvosym}                  % \Cross symbol for cross-linguistic subscripts
\usepackage{graphicx}                  % For including images
\usepackage{framed}                    % For framed boxes (skip paths)

% --- Quotation marks ---
\usepackage{csquotes}                  % \enquote{â€¦} with locale-aware quoting
\setquotestyle{english}                % Use double quotes even under british babel
\usepackage{orcidlink}

% --- Hyperlinks ---
\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  linkcolor=blue,
  citecolor=blue,
  urlcolor=blue,
  pdfauthor={Brett Reynolds}
  % pdftitle will be set in main document
}

% --- Maths and symbols ---
\usepackage{amsmath,amssymb}
\usepackage{tikz}                      % Required by pgfplots
\usetikzlibrary{arrows.meta, positioning, shapes.geometric}
\usepackage{pgfplots}                  % For data-driven figures
\pgfplotsset{compat=1.18}
\usepackage{epigraph}                  % For chapter epigraphs
\usepackage{booktabs}
\usepackage{makecell}

% --- Numbered linguistic examples (LangSci/gb4e wrapper, no 'exe' env) ---
\usepackage{langsci-gb4e}
\makeatletter
\@ifundefined{noautomath}{}{\noautomath}
\makeatother

% --- Lists & small utilities ---
\usepackage{enumitem}
\setlist{itemsep=0.3\baselineskip, topsep=0.3\baselineskip}
\usepackage{xspace}

% =========================
% Bibliography (biblatex)
% =========================
% Default portable setup:
\usepackage[backend=biber,style=apa,natbib=true,doi=true,isbn=false,url=true]{biblatex}
\addbibresource{references.bib}

% If working in LangSci projects, you can switch to their unified style:
% \usepackage[backend=biber,style=unified,natbib=true,doi=true,isbn=false,url=false]{biblatex}

% =========================
% Light house macros
% =========================
% Linguistic mentions (italics, for words as examples)
\newcommand{\mention}[1]{\textit{#1}}

% Technical terms when introduced (small caps, for key theoretical concepts)
\newcommand{\term}[1]{\textsc{#1}}

% Use \emph{} for emphasis (sparingly; semantically meaningful emphasis)

% Small-caps abbreviations for glosses
\newcommand{\abbr}[1]{\textsc{#1}}

% Cross-linguistic subscript marker (e.g., \textsc{subject}\crossmark)
\newcommand{\crossmark}{\textsubscript{\Cross}}

% Judgement markers
\newcommand{\ungram}[1]{*\!#1}
\newcommand{\marg}[1]{?\!#1}
\newcommand{\odd}[1]{\#\!#1}

% e.g., i.e., etc., with sensible spacing
\newcommand{\eg}{e.g.,\xspace}
\newcommand{\ie}{i.e.,\xspace}
\newcommand{\etc}{etc.\xspace}

% =========================
% Indices (imakeidx)
% =========================
\usepackage{imakeidx}

% Three indices: Subject (concepts), Names (authors), Lexical (mentioned words)
\makeindex[name=subject, title=Subject Index, columns=2]
\makeindex[name=names, title=Name Index, columns=2]
\makeindex[name=lexical, title=Lexical Index, columns=2, intoc]

% Helper macros for consistent indexing
\newcommand{\ixs}[1]{#1\index[subject]{#1}}         % Subject: inline + tag
\newcommand{\ixn}[1]{#1\index[names]{#1}}           % Names: inline + tag
\newcommand{\ixl}[1]{\mention{#1}\index[lexical]{#1}} % Lexical: italicised + tag
\newcommand{\ixsq}[1]{\index[subject]{#1}}          % Subject: tag only (quiet)
\newcommand{\ixnq}[1]{\index[names]{#1}}            % Names: tag only (quiet)
\newcommand{\ixlq}[1]{\index[lexical]{#1}}          % Lexical: tag only (quiet)

% =========================
% Glossary (glossaries-extra)
% =========================
\usepackage[toc, acronym, nopostdot, nonumberlist]{glossaries-extra}
\setabbreviationstyle[acronym]{long-short}

% --- Glossary entries (defined here; can be moved to separate file) ---

\newglossaryentry{hpc}{
  name={homeostatic property cluster (HPC)},
  text={HPC},
  description={A category whose members share properties not because of a common essence but because causal processes maintain the co-occurrence of those properties. Identified by two diagnostics: \emph{projectibility} (the category supports induction) and \emph{homeostasis} (named mechanisms maintain the cluster under perturbation). See Chs~4, 7, 8}
}

\newglossaryentry{projectibility}{
  name={projectibility},
  description={The property of a category that licenses inductive generalisation: knowing that an item belongs to the category allows prediction of its other properties. The first of two diagnostics for genuine kinds. See Ch~6}
}

\newglossaryentry{homeostasis}{
  name={homeostasis},
  description={The active maintenance of cluster coherence by identifiable causal mechanisms (acquisition, entrenchment, alignment, transmission, functional pressure). The second diagnostic for genuine kinds. See Chs~4, 7}
}

\newglossaryentry{entrenchment}{
  name={entrenchment},
  description={A cognitive mechanism whereby repeated exposure to a linguistic pattern strengthens its mental representation, making it more accessible and resistant to change. One of the stabilizers maintaining grammatical categories. See Ch~7}
}

\newglossaryentry{essentialism}{
  name={essentialism},
  description={The view that categories have definitions: necessary and sufficient conditions that determine membership. Contrasted with the maintenance view developed in this book. See Chs~1--3}
}

\makeglossaries

